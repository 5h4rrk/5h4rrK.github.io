<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>Windows Shellcode Development &amp; Debugging with WinDbg: A Hands-On Guide (Part 2) :: 5h4rrk </title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="A comprehensive guide to understanding and creating Windows shellcode from scratch for exploit development. This article includes practical insights into using WinDbg for effective debugging and analysis." />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="http://localhost:1313/posts/windows-shellcode2/" />


  







  
  
  
  
  
  <link rel="stylesheet" href="http://localhost:1313/styles.css">







  <link rel="shortcut icon" href="http://localhost:1313/img/theme-colors/orange.png">
  <link rel="apple-touch-icon" href="http://localhost:1313/img/theme-colors/orange.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Windows Shellcode Development &amp; Debugging with WinDbg: A Hands-On Guide (Part 2)">
<meta property="og:description" content="A comprehensive guide to understanding and creating Windows shellcode from scratch for exploit development. This article includes practical insights into using WinDbg for effective debugging and analysis." />
<meta property="og:url" content="http://localhost:1313/posts/windows-shellcode2/" />
<meta property="og:site_name" content="5h4rrk " />

  
    <meta property="og:image" content="http://localhost:1313/img/favicon/orange.png">
  

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2025-01-21 07:05:40 &#43;0530 IST" />













  


</head>
<body class="orange">




<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/posts">
  <div class="logo">
    shark.exe [0]
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/tags">Tags</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/tags" >Tags</a></li>
        
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="http://localhost:1313/posts/windows-shellcode2/">Windows Shellcode Development &amp; Debugging with WinDbg: A Hands-On Guide (Part 2)</a>
  </h1>
  <div class="post-meta"><time class="post-date">2025-01-21</time>
    
</div>

  
    <span class="post-tags">
      
      #<a href="http://localhost:1313/tags/windows-shellcode/">Windows Shellcode</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/malware-analysis/">Malware Analysis</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/exploit-development/">Exploit Development</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/assembly/">Assembly</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/windbg/">WinDbg</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/reverse-engineering/">Reverse Engineering</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/debugging/">Debugging</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/low-level/">Low-Level</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/windows-internals/">Windows Internals</a>&nbsp;
      
    </span>
  
  



  

  <div class="post-content"><div>
        <h2 id="prerequisites">Prerequisites<a href="#prerequisites" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Before diving into the content of this blog, it is recommended to familiarize yourself with the following topics.</p>
<ol>
<li><strong><a href="https://5h4rrk.github.io/posts/pe-parse-windbg/">PE Parsing with WinDbg</a></strong></li>
<li><strong><a href="https://5h4rrk.github.io/posts/windows-shellcode/">Windows Shellcode Development</a></strong></li>
</ol>
<h2 id="parsing-executable-with-assembly">Parsing Executable with Assembly<a href="#parsing-executable-with-assembly" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>In last <a href="https://5h4rrk.github.io/posts/windows-shellcode/">blog</a>, we wrote a program to iterate through the loaded modules and retrieve their names.</p>
<p>Let&rsquo;s add a new layer to our process: we&rsquo;ll parse the target loaded module.</p>
<p><strong>What would our target module be?</strong></p>
<p>For now, we&rsquo;ll focus on <code>KERNEL32.dll</code> as our target module.</p>
<p><strong>But how do we determine when to stop the iteration?</strong></p>
<p>If you&rsquo;ve gone through the previous part of the blog, you&rsquo;ll notice that <code>KERNEL32.dll</code> is loaded in the <strong>3rd position</strong>.</p>
<p>Here&rsquo;s the module layout for reference:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">00007ff7<span class="sb">`</span>bcf00000 00007ff7<span class="sb">`</span>bcf05000   execute  C <span class="o">(</span>pdb symbols<span class="o">)</span>          
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>d2310000 00007ff8<span class="sb">`</span>d26c2000   KERNELBASE   <span class="o">(</span>deferred<span class="o">)</span>             
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>d3930000 00007ff8<span class="sb">`</span>d39f8000   KERNEL32   <span class="o">(</span>pdb symbols<span class="o">)</span>          
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>d4f40000 00007ff8<span class="sb">`</span>d51a3000   ntdll      <span class="o">(</span>pdb symbols<span class="o">)</span> 
</span></span></code></pre></div><p>We will parse the <code>execute</code> module outside of the loop. As a result, we&rsquo;ll adjust the position value from <strong>3</strong> to <strong>2</strong>.</p>
<h3 id="plan">Plan<a href="#plan" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<ol>
<li><strong>Push a value (<code>0x02</code>) to the stack</strong>: This value will act as a counter to track whether we&rsquo;ve reached <code>KERNEL32.dll</code> or not.</li>
<li><strong>Parse the PEB and its fields</strong>: We&rsquo;ll follow the same parsing process as we did earlier.</li>
<li><strong>Decrement the value after each iteration</strong>: After parsing each module, we&rsquo;ll decrement the counter and update it on the stack; when the counter reaches <strong>0</strong>, we&rsquo;ll exit the loop.</li>
<li><strong>Store the <code>DllBase</code> before exiting the loop</strong>: Before exiting, we&rsquo;ll store the <code>DllBase</code> (the memory address where the DLL is loaded).</li>
<li><strong>Parse the PE after exiting the loop</strong>: Once out of the loop, we&rsquo;ll parse the Portable Executable (PE) structure of <code>KERNEL32.dll</code>.</li>
</ol>
<h3 id="implementation-assembly-code">Implementation (Assembly Code)<a href="#implementation-assembly-code" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h3 id="explanation-of-each-label">Explanation of Each Label<a href="#explanation-of-each-label" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<ul>
<li><strong><code>start</code></strong>: Parses the TEB, PEB, and <code>_LDR_DATA_TABLE_ENTRY</code>.</li>
<li><strong><code>find_names</code></strong>: Parses the <code>_LDR_DATA_TABLE_ENTRY</code>, finds the module name, and decrements the counter value.</li>
<li><strong><code>is_finished</code></strong>: Checks if the target DLL is found; if not, it continues parsing the next entry in <code>_LIST_ENTRY</code>.</li>
<li><strong><code>iterate_chars</code></strong>: Consumes the DLL names (optional checks can be added here, but they won’t be effective).</li>
<li><strong><code>next_iteration</code></strong>: Adjusts the <code>_LIST_ENTRY</code> and moves from the current to the next entry.</li>
<li><strong><code>load_address</code></strong>: Loads the DLL base address once the target DLL is found.</li>
<li><strong><code>parse_pe</code></strong>: Responsible for parsing the Portable Executable (PE) structure.</li>
<li><strong><code>exit</code></strong>:  Ensures smooth termination.</li>
</ul>
<p><code>shellcode.asm</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">bits</span><span class="w"> </span><span class="mi">64</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">section</span><span class="w"> </span><span class="p">.</span><span class="n">text</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">global</span><span class="w"> </span><span class="n">start</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">start</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">push</span><span class="w"> </span><span class="n">rbp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="n">rsp</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sub</span><span class="w">  </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1000</span><span class="w">                    </span><span class="p">;</span><span class="w"> </span><span class="mi">4096</span><span class="w"> </span><span class="n">bytes</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="mh">0x02</span><span class="w">                           </span><span class="p">;</span><span class="w"> </span><span class="n">Stops</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="no">KERNEL32</span><span class="p">.</span><span class="n">dll</span><span class="p">,</span><span class="w"> </span><span class="n">Counter</span><span class="w"> </span><span class="n">Value</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">gs</span>:<span class="p">[</span><span class="mh">0x60</span><span class="p">]</span><span class="w">                  </span><span class="p">;</span><span class="w"> </span><span class="no">TEB</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x18</span><span class="p">]</span><span class="w">               </span><span class="p">;</span><span class="w"> </span><span class="no">PEB</span><span class="p">.</span><span class="n">Ldr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x20</span><span class="p">]</span><span class="w">               </span><span class="p">;</span><span class="w"> </span><span class="no">PEB</span><span class="p">.</span><span class="n">Ldr</span>-&gt;<span class="nc">InMemoryOrderModuleList</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="p">]</span><span class="w">                      </span><span class="p">;</span><span class="w"> </span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sub</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="w">                       </span><span class="p">;</span><span class="w"> </span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="p">.</span><span class="n">InMemoryOrderLinks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">find_names</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">mov</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x08</span><span class="p">],</span><span class="w"> </span><span class="n">rax</span><span class="w">               </span><span class="p">;</span><span class="w"> </span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x58</span><span class="w">                       </span><span class="p">;</span><span class="w">  </span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="p">.</span><span class="n">BaseDllName</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">xor</span><span class="w"> </span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="n">rcx</span><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="p">]</span><span class="w">                      </span><span class="p">;</span><span class="w"> </span><span class="no">_UNICODE_STRING</span><span class="p">.</span><span class="n">Length</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">and</span><span class="w"> </span><span class="n">rcx</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mh">0x0fff</span><span class="w">                    </span><span class="p">;</span><span class="w"> </span><span class="n">Length</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">DllName</span><span class="w">  </span><span class="p">(</span><span class="no">WORD</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rbx</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="mh">0x08</span><span class="p">]</span><span class="w">             </span><span class="p">;</span><span class="w"> </span><span class="no">DLL</span><span class="w"> </span><span class="n">name</span><span class="w">  </span><span class="no">_UNICODE_STRING</span><span class="p">.</span><span class="n">Buffer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rdx</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="w"> </span><span class="p">]</span><span class="w">                    </span><span class="p">;</span><span class="w"> </span><span class="n">Moving</span><span class="w"> </span><span class="n">Counter</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="mi">2</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">dec</span><span class="w"> </span><span class="n">rdx</span><span class="w">                             </span><span class="p">;</span><span class="w"> </span><span class="n">Decrements</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">Counter</span><span class="w"> </span><span class="n">Value</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="n">rsp</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">rdx</span><span class="w">                   </span><span class="p">;</span><span class="w"> </span><span class="n">Updates</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">stack</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">is_finished</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">cmp</span><span class="w"> </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">je</span><span class="w"> </span><span class="n">load_address</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">jmp</span><span class="w"> </span><span class="n">iterate_chars</span><span class="w">                    </span><span class="p">;</span><span class="w"> </span><span class="n">Consumes</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="no">DLL</span><span class="w"> </span><span class="n">Name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">iterate_chars</span>:
</span></span><span class="line"><span class="cl">     <span class="nc">add</span><span class="w"> </span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="mh">0xfffffffffffffffe</span><span class="w">         </span><span class="p">;</span><span class="w"> </span><span class="n">Subtract</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">DllName</span><span class="w"> </span><span class="n">Length</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="mh">0xffffffffffffffff</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mh">0xfffffffffffffffe</span><span class="o">+</span><span class="mh">0x1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">cmp</span><span class="w"> </span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="w">                       </span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">je</span><span class="w"> </span><span class="n">next_iteration</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">jmp</span><span class="w"> </span><span class="n">iterate_chars</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">next_iteration</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">sub</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x58</span><span class="w">                        </span><span class="p">;</span><span class="w"> </span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="w">                        </span><span class="p">;</span><span class="w"> </span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="p">.</span><span class="n">InMemoryOrderLinks</span><span class="w"> </span><span class="p">(</span><span class="no">_LIST_ENTRY</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="p">]</span><span class="w">                      </span><span class="p">;</span><span class="w"> </span><span class="no">_LIST_ENTRY</span><span class="p">.</span><span class="n">Flink</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sub</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="w">   
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">jmp</span><span class="w"> </span><span class="n">find_names</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">load_address</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x08</span><span class="p">]</span><span class="w">                </span><span class="p">;</span><span class="w"> </span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x30</span><span class="p">]</span><span class="w">                </span><span class="p">;</span><span class="w">  </span><span class="n">DllBase</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">jmp</span><span class="w"> </span><span class="n">parse_pe</span><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">parse_pe</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">mov</span><span class="w">  </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rdx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">]</span><span class="w">               </span><span class="p">;</span><span class="w"> </span><span class="n">Offset</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="no">PE</span><span class="w"> </span><span class="n">Header</span><span class="p">,</span><span class="w"> </span><span class="n">rdx</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">DllBase</span><span class="w">     </span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">add</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">rbx</span><span class="w">                        </span><span class="p">;</span><span class="w"> </span><span class="no">_IMAGE_NT_HEADERS64</span><span class="w">           
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">edi</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rdx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x18</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x70</span><span class="p">]</span><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="no">_IMAGE_DATA_DIRECTORY</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">VirtualAddress</span><span class="w"> </span><span class="p">(</span><span class="mh">0xa3f90</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">xor</span><span class="w">  </span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="n">rcx</span><span class="w">                        </span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sub</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">rbx</span><span class="w">                        </span><span class="p">;</span><span class="w"> </span><span class="n">Backs</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="no">MZ</span><span class="w"> </span><span class="p">(</span><span class="n">DllBase</span><span class="p">)</span><span class="w">                   </span><span class="p">(</span><span class="mh">0x7ff84d590000</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">add</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">rdi</span><span class="w">                        </span><span class="p">;</span><span class="w"> </span><span class="n">DllBase</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">VirtualAddress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rdx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x18</span><span class="p">]</span><span class="w">               </span><span class="p">;</span><span class="w"> </span><span class="no">_IMAGE_EXPORT_DIRECTORY</span><span class="p">.</span><span class="n">NumberOfNames</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">xor</span><span class="w">  </span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="n">rsi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">esi</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rdx</span><span class="o">+</span><span class="w"> </span><span class="mh">0x1c</span><span class="p">]</span><span class="w">                </span><span class="p">;</span><span class="w"> </span><span class="no">_IMAGE_EXPORT_DIRECTORY</span><span class="p">.</span><span class="n">AddressofNames</span><span class="w">  </span><span class="p">(</span><span class="mh">0x0a3fb8</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sub</span><span class="w">  </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">rdi</span><span class="w">                        </span><span class="p">;</span><span class="w"> </span><span class="n">Back</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="no">MZ</span><span class="w"> </span><span class="p">(</span><span class="n">DllBase</span><span class="p">)</span><span class="w">                    </span><span class="p">(</span><span class="mh">0x7ff84d590000</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rdx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rsi</span><span class="p">]</span><span class="w">                </span><span class="p">;</span><span class="w">  </span><span class="n">DllBase</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">AddressofNames</span><span class="p">)</span><span class="w">            </span><span class="p">(</span><span class="mh">0x0a81a5</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">add</span><span class="w">  </span><span class="n">rbx</span><span class="p">,</span><span class="w"> </span><span class="n">rdx</span><span class="w">                        </span><span class="p">;</span><span class="w"> </span><span class="p">(</span><span class="mh">0x00007ff84d6381a5</span><span class="w"> </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">NTDLL</span><span class="p">.</span><span class="n">RtlAcquireSRWLockExclusive</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">exit</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">pop</span><span class="w"> </span><span class="n">r8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="n">rbp</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">pop</span><span class="w"> </span><span class="n">rbp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ret</span><span class="w">
</span></span></span></code></pre></div><p>Assemble and Link it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nasm -f win64 -g -F cv8 -o shellcode.obj shellcode.asm
</span></span><span class="line"><span class="cl">link /SUBSYSTEM:CONSOLE /ENTRY:start /OUT:execute.exe /DEBUG  shellcode.obj 
</span></span></code></pre></div><p>Open the executable in a debugger (WinDbg or x64dbg).</p>
<p>I&rsquo;m using <strong>WinDbg</strong> for this process:</p>
<ul>
<li>Set a breakpoint at <code>execute!start+0xa1</code>.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt; g
</span></span><span class="line"><span class="cl">Breakpoint <span class="m">1</span> hit
</span></span><span class="line"><span class="cl">execute!start+0xa1:
</span></span><span class="line"><span class="cl">00007ff6<span class="sb">`</span>15c210a1 <span class="m">4158</span>            pop     r8
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0:000&gt; db @rbx
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>4d6381a5  4e <span class="m">54</span> <span class="m">44</span> 4c 4c 2e <span class="m">52</span> 74-6c <span class="m">41</span> <span class="m">63</span> <span class="m">71</span> <span class="m">75</span> <span class="m">69</span> <span class="m">72</span> <span class="m">65</span>  NTDLL.RtlAcquire
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>4d6381b5  <span class="m">53</span> <span class="m">52</span> <span class="m">57</span> 4c 6f <span class="m">63</span> 6b 45-78 <span class="m">63</span> 6c <span class="m">75</span> <span class="m">73</span> <span class="m">69</span> <span class="m">76</span> <span class="m">65</span>  SRWLockExclusive
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>4d6381c5  <span class="m">00</span> <span class="m">41</span> <span class="m">63</span> <span class="m">71</span> <span class="m">75</span> <span class="m">69</span> <span class="m">72</span> 65-53 <span class="m">52</span> <span class="m">57</span> 4c 6f <span class="m">63</span> 6b <span class="m">53</span>  .AcquireSRWLockS
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>4d6381d5  <span class="m">68</span> <span class="m">61</span> <span class="m">72</span> <span class="m">65</span> <span class="m">64</span> <span class="m">00</span> 4e 54-44 4c 4c 2e <span class="m">52</span> <span class="m">74</span> 6c <span class="m">41</span>  hared.NTDLL.RtlA
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>4d6381e5  <span class="m">63</span> <span class="m">71</span> <span class="m">75</span> <span class="m">69</span> <span class="m">72</span> <span class="m">65</span> <span class="m">53</span> 52-57 4c 6f <span class="m">63</span> 6b <span class="m">53</span> <span class="m">68</span> <span class="m">61</span>  cquireSRWLockSha
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>4d6381f5  <span class="m">72</span> <span class="m">65</span> <span class="m">64</span> <span class="m">00</span> <span class="m">41</span> <span class="m">63</span> <span class="m">74</span> 69-76 <span class="m">61</span> <span class="m">74</span> <span class="m">65</span> <span class="m">41</span> <span class="m">63</span> <span class="m">74</span> <span class="m">43</span>  red.ActivateActC
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>4d638205  <span class="m">74</span> <span class="m">78</span> <span class="m">00</span> <span class="m">41</span> <span class="m">63</span> <span class="m">74</span> <span class="m">69</span> 76-61 <span class="m">74</span> <span class="m">65</span> <span class="m">41</span> <span class="m">63</span> <span class="m">74</span> <span class="m">43</span> <span class="m">74</span>  tx.ActivateActCt
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>4d638215  <span class="m">78</span> <span class="m">57</span> 6f <span class="m">72</span> 6b <span class="m">65</span> <span class="m">72</span> 00-41 <span class="m">63</span> <span class="m">74</span> <span class="m">69</span> <span class="m">76</span> <span class="m">61</span> <span class="m">74</span> <span class="m">65</span>  xWorker.Activate
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0:000&gt; da @rbx
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>4d6381a5  <span class="s2">&#34;NTDLL.RtlAcquireSRWLockExclusive&#34;</span>
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>4d6381c5  <span class="s2">&#34;&#34;</span>
</span></span></code></pre></div><p>Here&rsquo;s a screenshot from <code>objdump</code> to verify that our implementation is correct:</p>
<p><img alt="alt text" src="/posts/windows-shellcode2/image-3.png"></p>
<p>We can use this to confirm that the steps we&rsquo;ve taken are accurate.</p>
<h2 id="resolving-api">Resolving API<a href="#resolving-api" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h3 id="techniques">Techniques<a href="#techniques" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>In the above code, we used a hardcoded position value, which is not an effective or flexible approach. To make it independent, we can implement it in various ways:</p>
<h4 id="1-push-the-target-dll-name-to-the-stack-and-compare">1. <strong>Push the Target DLL Name to the Stack and Compare</strong><a href="#1-push-the-target-dll-name-to-the-stack-and-compare" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<ul>
<li><strong>How it works</strong>: Push the target DLL name (e.g., <code>KERNEL32.dll</code>) onto the stack and compare it during iteration.</li>
<li><strong>Issue</strong>: This method is easily detectable, as the DLL name is stored in plain text, making it vulnerable to static analysis.</li>
</ul>
<h4 id="2-calculate-hashes-for-the-target-dll-and-export-function">2. <strong>Calculate Hashes for the Target DLL and Export Function</strong><a href="#2-calculate-hashes-for-the-target-dll-and-export-function" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<ul>
<li><strong>How it works</strong>:
<ul>
<li>Compute a hash for the target DLL name and its exported functions.</li>
<li>Push the hash values onto the stack.</li>
<li>During runtime, dynamically resolve the DLL and function by comparing hashes.</li>
</ul>
</li>
<li><strong>Advantage</strong>: This approach is more stealthy and avoids storing plain-text strings, making it harder to detect.</li>
<li><strong>Feasibility</strong>: Since we&rsquo;ve already achieved PE parsing, we can leverage it to resolve the DLL and its exports dynamically.</li>
</ul>
<p>By using hashes, we can make the code more robust, independent, and resistant to detection.</p>
<p>For now, I&rsquo;m going with the <strong>second approach</strong>: calculating hashes for the target DLL and its exported functions. This method ensures better stealth and independence, making the code more robust and harder to detect.</p>
<h2 id="api-hashing">API Hashing<a href="#api-hashing" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Hash Algorithm</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_hash</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">VAL</span> <span class="o">=</span> <span class="mi">13</span>
</span></span><span class="line"><span class="cl">    <span class="n">final_result</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">        <span class="n">final_result</span> <span class="o">+=</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">VAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
</span></span><span class="line"><span class="cl">        <span class="n">final_result</span> <span class="o">+=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">final_result</span> <span class="o">&amp;=</span> <span class="mh">0xffffffff</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">final_result</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;KERNEL32.DLL : &#34;</span><span class="p">,</span><span class="nb">hex</span><span class="p">(</span><span class="n">get_hash</span><span class="p">(</span><span class="s2">&#34;KERNEL32.DLL&#34;</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;GetCurrentProcessId :&#34;</span><span class="p">,</span><span class="nb">hex</span><span class="p">(</span><span class="n">get_hash</span><span class="p">(</span><span class="s2">&#34;GetCurrentProcessId&#34;</span><span class="p">)))</span>
</span></span></code></pre></div><p><strong>Output</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">KERNEL32.DLL :  0x660330
</span></span><span class="line"><span class="cl">GetCurrentProcessId : 0xf1e78f
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">bits</span><span class="w"> </span><span class="mi">64</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">section</span><span class="w"> </span><span class="p">.</span><span class="n">text</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">global</span><span class="w"> </span><span class="n">start</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">start</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">push</span><span class="w"> </span><span class="n">rbp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w">  </span><span class="n">rbp</span><span class="p">,</span><span class="w"> </span><span class="n">rsp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sub</span><span class="w">  </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1000</span><span class="w">                           </span><span class="p">;</span><span class="w"> </span><span class="mi">4096</span><span class="w"> </span><span class="n">bytes</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="mh">0x660330</span><span class="w">                              </span><span class="p">;</span><span class="w"> </span><span class="no">KERNEL32</span><span class="p">.</span><span class="no">DLL</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sub</span><span class="w"> </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08</span><span class="w">                              </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">gs</span>:<span class="p">[</span><span class="mh">0x60</span><span class="p">]</span><span class="w">                         </span><span class="p">;</span><span class="w"> </span><span class="no">TEB</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x18</span><span class="p">]</span><span class="w">                      </span><span class="p">;</span><span class="w"> </span><span class="no">PEB</span><span class="p">.</span><span class="n">Ldr</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x20</span><span class="p">]</span><span class="w">                      </span><span class="p">;</span><span class="w">  </span><span class="no">PEB</span><span class="p">.</span><span class="n">Ldr</span>-&gt;<span class="nc">InMemoryOrderModuleList</span><span class="p">.</span><span class="n">Flink</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rbx</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="p">]</span><span class="w">                            </span><span class="p">;</span><span class="w"> </span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="p">.</span><span class="n">InMemoryOrderLinks</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">rbx</span><span class="w">                                   </span><span class="p">;</span><span class="w"> </span><span class="n">Will</span><span class="w"> </span><span class="n">Restore</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">later</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">rbx</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="w">                              </span><span class="p">;</span><span class="w"> </span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="p">.</span><span class="n">BaseDLlName</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">jmp</span><span class="w"> </span><span class="n">find_base_name</span><span class="w">                         
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">init_regs</span>:                                      <span class="p">;</span><span class="w"> </span><span class="n">Resets</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">registers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">xor</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w">                                
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">xor</span><span class="w"> </span><span class="n">r8</span><span class="p">,</span><span class="w"> </span><span class="n">r8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ret</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">calc_hash_core</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">mov</span><span class="w"> </span><span class="n">dl</span><span class="p">,</span><span class="w"> </span><span class="n">al</span><span class="w">                          
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">shl</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">and</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0fffffff</span><span class="w">                        </span><span class="p">;</span><span class="w"> </span><span class="n">Avoids</span><span class="w"> </span><span class="n">overflows</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="n">dl</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">r8d</span><span class="p">,</span><span class="w"> </span><span class="n">eax</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">xor</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">find_base_name</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">call</span><span class="w"> </span><span class="n">near</span><span class="w"> </span><span class="n">init_regs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rbx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x08</span><span class="p">]</span><span class="w">                     </span><span class="p">;</span><span class="w"> </span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="p">.</span><span class="n">BaseDLlName</span>-&gt;<span class="nc">_UNICODE_STRING</span><span class="p">.</span><span class="n">Buffer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">calc_hash</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">lodsw</span><span class="w">                                     </span><span class="p">;</span><span class="w"> </span><span class="n">Loads</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="n">bytes</span><span class="w">       
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">cmp</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w">                                 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">je</span><span class="w"> </span><span class="n">check_and_continue</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="n">calc_hash_core</span><span class="w">                       </span><span class="p">;</span><span class="w"> </span><span class="n">Calcuates</span><span class="w"> </span><span class="n">hash</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">jmp</span><span class="w"> </span><span class="n">calc_hash</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">check_and_continue</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">cmp</span><span class="w"> </span><span class="n">r8d</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x08</span><span class="p">]</span><span class="w">                       </span><span class="p">;</span><span class="w"> </span><span class="n">Compare</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">calculated</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">loaded</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">pushed</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="n">value</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">je</span><span class="w"> </span><span class="n">load_base_address</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">walk_through</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="w"> </span><span class="p">]</span><span class="w">                             </span><span class="p">;</span><span class="w"> </span><span class="n">Restores</span><span class="w"> </span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x10</span><span class="w"> </span><span class="p">(</span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="p">.</span><span class="n">InMemoryOrderLinks</span><span class="w"> </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sub</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="n">h</span><span class="w">                                </span><span class="p">;</span><span class="w"> </span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="w">                 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rbx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x10</span><span class="p">]</span><span class="w">                       </span><span class="p">;</span><span class="w"> </span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="p">.</span><span class="n">Flink</span><span class="w">           
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">rbx</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="w">                               </span><span class="p">;</span><span class="w"> </span><span class="no">_LDR_DATA_TABLE_ENTRY</span>-&gt;<span class="nc">Flink</span><span class="p">.</span><span class="n">BaseDLLName</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">pop</span><span class="w"> </span><span class="n">rdx</span><span class="w">                                     </span><span class="p">;</span><span class="w"> </span><span class="n">Popping</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">pushed</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="p">.</span><span class="n">InMemoryOrderLinks</span><span class="w"> </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">pop</span><span class="w"> </span><span class="n">rdx</span><span class="w">                                     </span><span class="p">;</span><span class="w"> </span><span class="n">Popping</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">pushed</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="no">KERNEL32</span><span class="p">.</span><span class="n">dll</span><span class="w"> </span><span class="n">Hash</span><span class="w"> </span><span class="n">Value</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">push</span><span class="w"> </span><span class="n">rbx</span><span class="w">                                    </span><span class="p">;</span><span class="w"> </span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="p">.</span><span class="n">BaseDllName</span><span class="w"> </span><span class="p">(</span><span class="mh">0x58</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">jmp</span><span class="w"> </span><span class="n">find_base_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">load_base_address</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rbx</span><span class="w">                                </span><span class="p">;</span><span class="w"> </span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="p">.</span><span class="n">BaseDllName</span><span class="w">  </span><span class="p">(</span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="o">+</span><span class="mh">0x58</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sub</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x28</span><span class="w">                               </span><span class="p">;</span><span class="w"> </span><span class="n">DLLBase</span><span class="w"> </span><span class="p">(</span><span class="n">BaseAddress</span><span class="p">)</span><span class="w">              </span><span class="p">(</span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x30</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="p">]</span><span class="w">                              </span><span class="p">;</span><span class="w"> </span><span class="n">DLlBase</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">jmp</span><span class="w"> </span><span class="n">pe_parse</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">again_calc_hash_wrapper</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">call</span><span class="w"> </span><span class="n">init_regs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">jmp</span><span class="w"> </span><span class="n">again_calc_hash</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">again_calc_hash</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">lodsb</span><span class="w">                                       </span><span class="p">;</span><span class="w"> </span><span class="n">Loads</span><span class="w"> </span><span class="n">single</span><span class="w"> </span><span class="n">byte</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">cmp</span><span class="w"> </span><span class="n">al</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="w">                      
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">je</span><span class="w"> </span><span class="n">func_ends</span><span class="w">                   
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="n">calc_hash_core</span><span class="w">                         </span><span class="p">;</span><span class="w"> </span><span class="n">Calculates</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">hash</span><span class="w">            
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">jmp</span><span class="w"> </span><span class="n">again_calc_hash</span><span class="w">                         
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">func_ends</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">mov</span><span class="w"> </span><span class="n">r11d</span><span class="p">,</span><span class="w"> </span><span class="n">r8d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ret</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">pe_parse</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">push</span><span class="w"> </span><span class="n">rax</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rdi</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">rax</span><span class="w">                            </span><span class="p">;</span><span class="w"> </span><span class="n">DllBase</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rdx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x3c</span><span class="p">]</span><span class="w">                   </span><span class="p">;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="no">PE</span><span class="w"> </span><span class="n">header</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rbx</span><span class="w">                            </span><span class="p">;</span><span class="w"> </span><span class="no">PE</span><span class="w"> </span><span class="n">Header</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="mi">18</span><span class="n">h</span><span class="o">+</span><span class="mi">70</span><span class="n">h</span><span class="p">]</span><span class="w">                  </span><span class="p">;</span><span class="w"> </span><span class="no">IMAGE_DATA_DIRECTORY</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="no">EXPORT_TABLE</span><span class="p">.</span><span class="n">Address</span><span class="w"> </span><span class="p">(</span><span class="no">RVA</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rdx</span><span class="w">                            </span><span class="p">;</span><span class="w"> </span><span class="no">RVA</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">BaseAddress</span><span class="w"> </span>-&gt; <span class="p">(</span><span class="no">VMA</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">xor</span><span class="w"> </span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="n">rcx</span><span class="w">                            </span><span class="p">;</span><span class="w"> </span><span class="n">Resetting</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="n">value</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">18</span><span class="n">h</span><span class="p">]</span><span class="w">                    </span><span class="p">;</span><span class="w"> </span><span class="n">NumberOfNames</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">eax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">20</span><span class="n">h</span><span class="p">]</span><span class="w">                    </span><span class="p">;</span><span class="w"> </span><span class="n">AddressOfNames</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rdx</span><span class="w">                            
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">jmp</span><span class="w"> </span><span class="n">resolve_functions</span><span class="w">                   
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">restore_address</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">xor</span><span class="w"> </span><span class="n">rbx</span><span class="p">,</span><span class="w"> </span><span class="n">rbx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rdx</span><span class="p">,</span><span class="w"> </span><span class="n">rdi</span><span class="w">                            </span><span class="p">;</span><span class="w"> </span><span class="n">BaseAddress</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="p">]</span><span class="w">                          </span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">resolve_functions</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">mov</span><span class="w"> </span><span class="n">ebx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="p">]</span><span class="w">                          </span><span class="p">;</span><span class="w"> </span><span class="no">_IMAGE_EXPORT_DIRECTORY</span><span class="p">.</span><span class="n">AddressOfNames</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">cmp</span><span class="w"> </span><span class="n">ecx</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="w">                            </span><span class="p">;</span><span class="w"> </span><span class="n">End</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">AddressOfNames</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">je</span><span class="w"> </span><span class="n">trap</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">dec</span><span class="w"> </span><span class="n">rcx</span><span class="w">                                 </span><span class="p">;</span><span class="w"> </span><span class="n">Decrement</span><span class="w"> </span><span class="n">Counter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">rbx</span><span class="p">,</span><span class="w"> </span><span class="n">rdx</span><span class="w">                            </span><span class="p">;</span><span class="w"> </span><span class="n">BaseAddress</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">AddressofNames</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rsi</span><span class="p">,</span><span class="w"> </span><span class="n">rbx</span><span class="w">                            </span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x04</span><span class="w">                           </span><span class="p">;</span><span class="w"> </span><span class="n">Next</span><span class="w"> </span><span class="n">Function</span><span class="w"> </span><span class="n">Address</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="p">],</span><span class="w"> </span><span class="n">rax</span><span class="w">                          </span><span class="p">;</span><span class="w"> </span><span class="n">Loads</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">address</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">call</span><span class="w"> </span><span class="n">again_calc_hash_wrapper</span><span class="w">             </span><span class="p">;</span><span class="w"> </span><span class="n">Calculate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">function</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">cmp</span><span class="w"> </span><span class="n">r8d</span><span class="p">,</span><span class="w"> </span><span class="mh">0xf1e78f</span><span class="w">                       </span><span class="p">;</span><span class="w"> </span><span class="n">Compares</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">calculated</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">GetCurrentProcessId</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">je</span><span class="w"> </span><span class="n">found_target_fn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">jmp</span><span class="w"> </span><span class="n">restore_address</span><span class="w">                     
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">trap</span>:   
</span></span><span class="line"><span class="cl">    <span class="nc">int</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">found_target_fn</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">mov</span><span class="w"> </span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="n">rbp</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">pop</span><span class="w"> </span><span class="n">rbp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ret</span><span class="w">
</span></span></span></code></pre></div><img src="https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExbzhjaXlpN3lnNmM0ajJ5aDNma3l3eHQzMHJjcXUzdGM0ZjE4dDdtbyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/Zh0De6qyNjDdmxy8Za/giphy.gif" alt="alt text" width="200"/>
<p>Yeah, this looks <em>fantastic</em>-said no one ever. Don&rsquo;t worry, I&rsquo;ll write cleaner version of it.</p>
<p><code>run.wds</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="p">.</span><span class="nx">block</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">bp</span> <span class="nx">rip</span> <span class="s2">&#34;da rsi; .if ($t0 &lt; 0x66A) { r $t0 = $t0 + 1; gc } .else {  }&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">r</span> <span class="nx">$t0</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">g</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>Set breakpoint at <code>call again_calc_hash_wrapper</code></li>
</ul>
<p>Load the script</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$&gt;&lt;D:<span class="se">\r</span>un.wds
</span></span></code></pre></div><p><img alt="alt text" src="/posts/windows-shellcode2/image.png"></p>
<p>:)</p>

      </div></div>

  
    
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h"></span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="http://localhost:1313/posts/dumpanalysis/">
                <span class="button__icon">←</span>
                <span class="button__text">Kernel Memory Dump Analysis : Introduction</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="http://localhost:1313/posts/windows-shellcode/">
                <span class="button__text">Windows Shellcode Development &amp; Debugging with WinDbg: A Hands-On Guide (Part 1)</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/mirus-ua/hugo-theme-re-terminal" target="_blank">Theme</a> made by <a href="https://github.com/mirus-ua" target="_blank">Mirus</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>








  
</div>

</body>
</html>
