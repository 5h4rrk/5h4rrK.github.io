<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>Windows Shellcode Development &amp; Debugging with WinDbg: A Hands-On Guide (Part 1) :: 5h4rrk </title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="A comprehensive guide to understanding and creating Windows shellcode from scratch for exploit development. This article includes practical insights into using WinDbg for effective debugging and analysis." />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="http://localhost:1313/posts/windows-shellcode/" />


  







  
  
  
  
  
  <link rel="stylesheet" href="http://localhost:1313/styles.css">







  <link rel="shortcut icon" href="http://localhost:1313/img/theme-colors/orange.png">
  <link rel="apple-touch-icon" href="http://localhost:1313/img/theme-colors/orange.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Windows Shellcode Development &amp; Debugging with WinDbg: A Hands-On Guide (Part 1)">
<meta property="og:description" content="A comprehensive guide to understanding and creating Windows shellcode from scratch for exploit development. This article includes practical insights into using WinDbg for effective debugging and analysis." />
<meta property="og:url" content="http://localhost:1313/posts/windows-shellcode/" />
<meta property="og:site_name" content="5h4rrk " />

  
    <meta property="og:image" content="http://localhost:1313/img/favicon/orange.png">
  

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2025-01-12 16:22:44 &#43;0530 IST" />













  


</head>
<body class="orange">




<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/posts">
  <div class="logo">
    shark.exe [0]
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;â–¾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/tags">Tags</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/tags" >Tags</a></li>
        
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="http://localhost:1313/posts/windows-shellcode/">Windows Shellcode Development &amp; Debugging with WinDbg: A Hands-On Guide (Part 1)</a>
  </h1>
  <div class="post-meta"><time class="post-date">2025-01-12</time>
    
</div>

  
    <span class="post-tags">
      
      #<a href="http://localhost:1313/tags/windows-shellcode/">Windows Shellcode</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/malware-analysis/">Malware Analysis</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/exploit-development/">Exploit Development</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/assembly/">Assembly</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/windbg/">WinDbg</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/reverse-engineering/">Reverse Engineering</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/debugging/">Debugging</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/low-level/">Low-Level</a>&nbsp;
      
      #<a href="http://localhost:1313/tags/windows-internals/">Windows Internals</a>&nbsp;
      
    </span>
  
  



  

  <div class="post-content"><div>
        <h3 id="exploring-strucutures">Exploring Strucutures<a href="#exploring-strucutures" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<h4 id="tebthread-environment-block">TEB(Thread Environment Block)<a href="#tebthread-environment-block" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt; dt nt!_TEB
</span></span><span class="line"><span class="cl">ntdll!_TEB
</span></span><span class="line"><span class="cl">   +0x000 NtTib            : _NT_TIB
</span></span><span class="line"><span class="cl">   +0x038 EnvironmentPointer : Ptr64 Void
</span></span><span class="line"><span class="cl">   +0x040 ClientId         : _CLIENT_ID
</span></span><span class="line"><span class="cl">   +0x050 ActiveRpcHandle  : Ptr64 Void
</span></span><span class="line"><span class="cl">   +0x058 ThreadLocalStoragePointer : Ptr64 Void
</span></span><span class="line"><span class="cl">   +0x060 ProcessEnvironmentBlock : Ptr64 _PEB
</span></span><span class="line"><span class="cl">   ....
</span></span><span class="line"><span class="cl">   .... 
</span></span></code></pre></div><h4 id="pebprocess-environment-block">PEB(Process Environment Block)<a href="#pebprocess-environment-block" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:023&gt; dt nt!_PEB -y LDR
</span></span><span class="line"><span class="cl">    ntdll!_PEB
</span></span><span class="line"><span class="cl">        +0x018 Ldr : Ptr64 _PEB_LDR_DATA     
</span></span></code></pre></div><h5 id="peb_ldr_data">PEB_LDR_DATA<a href="#peb_ldr_data" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:023&gt; dt nt!_PEB_LDR_DATA
</span></span><span class="line"><span class="cl">ntdll!_PEB_LDR_DATA
</span></span><span class="line"><span class="cl">   +0x000 Length           : Uint4B
</span></span><span class="line"><span class="cl">   +0x004 Initialized      : UChar
</span></span><span class="line"><span class="cl">   +0x008 SsHandle         : Ptr64 Void
</span></span><span class="line"><span class="cl">   +0x010 InLoadOrderModuleList : _LIST_ENTRY
</span></span><span class="line"><span class="cl">   +0x020 InMemoryOrderModuleList : _LIST_ENTRY
</span></span><span class="line"><span class="cl">   +0x030 InInitializationOrderModuleList : _LIST_ENTRY
</span></span><span class="line"><span class="cl">   +0x040 EntryInProgress  : Ptr64 Void
</span></span><span class="line"><span class="cl">   +0x048 ShutdownInProgress : UChar
</span></span><span class="line"><span class="cl">   +0x050 ShutdownThreadId : Ptr64 Void
</span></span></code></pre></div><h5 id="ldr_data_table_entry">LDR_DATA_TABLE_ENTRY<a href="#ldr_data_table_entry" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:023&gt; dt nt!_LDR_DATA_TABLE_ENTRY
</span></span><span class="line"><span class="cl">ntdll!_LDR_DATA_TABLE_ENTRY
</span></span><span class="line"><span class="cl">   +0x000 InLoadOrderLinks : _LIST_ENTRY
</span></span><span class="line"><span class="cl">   +0x010 InMemoryOrderLinks : _LIST_ENTRY
</span></span><span class="line"><span class="cl">   +0x020 InInitializationOrderLinks : _LIST_ENTRY
</span></span><span class="line"><span class="cl">   +0x030 DllBase          : Ptr64 Void
</span></span><span class="line"><span class="cl">   +0x038 EntryPoint       : Ptr64 Void
</span></span><span class="line"><span class="cl">   +0x040 SizeOfImage      : Uint4B
</span></span><span class="line"><span class="cl">   +0x048 FullDllName      : _UNICODE_STRING
</span></span><span class="line"><span class="cl">   +0x058 BaseDllName      : _UNICODE_STRING
</span></span></code></pre></div><h4 id="parsing-the-peb-structure">Parsing the PEB Structure<a href="#parsing-the-peb-structure" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt; dt nt!_PEB <span class="o">(</span>@rax<span class="o">)</span>
</span></span><span class="line"><span class="cl">ntdll!_PEB
</span></span><span class="line"><span class="cl">   +0x000 InheritedAddressSpace : <span class="m">0</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">   +0x001 ReadImageFileExecOptions : <span class="m">0</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">   +0x002 BeingDebugged    : 0x1 <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">   +0x003 BitField         : 0x4 <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">   +0x003 ImageUsesLargePages : 0y0
</span></span><span class="line"><span class="cl">   +0x003 IsProtectedProcess : 0y0
</span></span><span class="line"><span class="cl">   +0x003 IsImageDynamicallyRelocated : 0y1
</span></span><span class="line"><span class="cl">   +0x003 SkipPatchingUser32Forwarders : 0y0
</span></span><span class="line"><span class="cl">   +0x003 IsPackagedProcess : 0y0
</span></span><span class="line"><span class="cl">   +0x003 IsAppContainer   : 0y0
</span></span><span class="line"><span class="cl">   +0x003 IsProtectedProcessLight : 0y0
</span></span><span class="line"><span class="cl">   +0x003 IsLongPathAwareProcess : 0y0
</span></span><span class="line"><span class="cl">   +0x004 Padding0         : <span class="o">[</span>4<span class="o">]</span>  <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">   +0x008 Mutant           : 0xffffffff<span class="sb">`</span>ffffffff Void
</span></span><span class="line"><span class="cl">   +0x010 ImageBaseAddress : 0x00007ff6<span class="sb">`</span><span class="m">14910000</span> Void
</span></span><span class="line"><span class="cl">   +0x018 Ldr              : 0x00007ff8<span class="sb">`</span>d51108c0 _PEB_LDR_DATA
</span></span><span class="line"><span class="cl">   +0x020 ProcessParameters : 0x0000019b<span class="sb">`</span>49df57b0 _RTL_USER_PROCESS_PARAMETERS
</span></span></code></pre></div><h4 id="parsing-the-peb_ldr_data-structure">Parsing the PEB_LDR_DATA Structure<a href="#parsing-the-peb_ldr_data-structure" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt; dt nt!_PEB_LDR_DATA 0x00007ff8<span class="sb">`</span>d51108c0
</span></span><span class="line"><span class="cl">ntdll!_PEB_LDR_DATA
</span></span><span class="line"><span class="cl">   +0x000 Length           : 0x58
</span></span><span class="line"><span class="cl">   +0x004 Initialized      : 0x1 <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">   +0x008 SsHandle         : <span class="o">(</span>null<span class="o">)</span> 
</span></span><span class="line"><span class="cl">   +0x010 InLoadOrderModuleList : _LIST_ENTRY <span class="o">[</span> 0x0000019b<span class="sb">`</span>49df62f0 - 0x0000019b<span class="sb">`</span>49df70d0 <span class="o">]</span>
</span></span><span class="line"><span class="cl">   +0x020 InMemoryOrderModuleList : _LIST_ENTRY <span class="o">[</span> 0x0000019b<span class="sb">`</span>49df6300 - 0x0000019b<span class="sb">`</span>49df70e0 <span class="o">]</span>
</span></span><span class="line"><span class="cl">   +0x030 InInitializationOrderModuleList : _LIST_ENTRY <span class="o">[</span> 0x0000019b<span class="sb">`</span>49df6060 - 0x0000019b<span class="sb">`</span>49df68e0 <span class="o">]</span>
</span></span><span class="line"><span class="cl">   +0x040 EntryInProgress  : <span class="o">(</span>null<span class="o">)</span> 
</span></span><span class="line"><span class="cl">   +0x048 ShutdownInProgress : <span class="m">0</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">   +0x050 ShutdownThreadId : <span class="o">(</span>null<span class="o">)</span> 
</span></span></code></pre></div><h4 id="parsing-the-ldr_data_table_entry-structure">Parsing the LDR_DATA_TABLE_ENTRY Structure<a href="#parsing-the-ldr_data_table_entry-structure" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt;  dt nt!_LDR_DATA_TABLE_ENTRY 0x0000019b<span class="sb">`</span>49df6300
</span></span><span class="line"><span class="cl">ntdll!_LDR_DATA_TABLE_ENTRY
</span></span><span class="line"><span class="cl">   +0x000 InLoadOrderLinks : _LIST_ENTRY <span class="o">[</span> 0x0000019b<span class="sb">`</span>49df6050 - 0x00007ff8<span class="sb">`</span>d51108e0 <span class="o">]</span>
</span></span><span class="line"><span class="cl">   +0x010 InMemoryOrderLinks : _LIST_ENTRY <span class="o">[</span> 0x00000000<span class="sb">`</span><span class="m">00000000</span> - 0x00000000<span class="sb">`</span><span class="m">00000000</span> <span class="o">]</span> &lt;-----------  While Travesing, it points to 0x10 Offset .So, subtract it
</span></span></code></pre></div><p>The InMemoryOrderLinks is located at 0x10 offset. Subtract it with 0x10 for proper alignment.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt; dt nt!_LDR_DATA_TABLE_ENTRY 0x0000019b<span class="sb">`</span>49df6300-10
</span></span><span class="line"><span class="cl">ntdll!_LDR_DATA_TABLE_ENTRY
</span></span><span class="line"><span class="cl">   +0x000 InLoadOrderLinks : _LIST_ENTRY <span class="o">[</span> 0x0000019b<span class="sb">`</span>49df6040 - 0x00007ff8<span class="sb">`</span>d51108d0 <span class="o">]</span>
</span></span><span class="line"><span class="cl">   +0x010 InMemoryOrderLinks : _LIST_ENTRY <span class="o">[</span> 0x0000019b<span class="sb">`</span>49df6050 - 0x00007ff8<span class="sb">`</span>d51108e0 <span class="o">]</span> 
</span></span><span class="line"><span class="cl">   +0x020 InInitializationOrderLinks : _LIST_ENTRY <span class="o">[</span> 0x00000000<span class="sb">`</span><span class="m">00000000</span> - 0x00000000<span class="sb">`</span><span class="m">00000000</span> <span class="o">]</span>
</span></span><span class="line"><span class="cl">   +0x030 DllBase          : 0x00007ff6<span class="sb">`</span><span class="m">14910000</span> Void
</span></span><span class="line"><span class="cl">   +0x038 EntryPoint       : 0x00007ff6<span class="sb">`</span><span class="m">14911000</span> Void
</span></span><span class="line"><span class="cl">   +0x040 SizeOfImage      : 0x5000
</span></span><span class="line"><span class="cl">   +0x048 FullDllName      : _UNICODE_STRING <span class="s2">&#34;F:\temp\execute.exe&#34;</span>
</span></span><span class="line"><span class="cl">   +0x058 BaseDllName      : _UNICODE_STRING <span class="s2">&#34;execute.exe&#34;</span>
</span></span><span class="line"><span class="cl">   +0x068 FlagGroup        : <span class="o">[</span>4<span class="o">]</span>  <span class="s2">&#34;???&#34;</span>
</span></span><span class="line"><span class="cl">    ....
</span></span><span class="line"><span class="cl">   +0x0c0 SwitchBackContext : 0x00007ff8<span class="sb">`</span>d50b1004 Void
</span></span><span class="line"><span class="cl">   +0x0c8 BaseAddressIndexNode : _RTL_BALANCED_NODE
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt;  dt nt!_LDR_DATA_TABLE_ENTRY 0x0000019b<span class="sb">`</span>49df6050-10
</span></span><span class="line"><span class="cl">ntdll!_LDR_DATA_TABLE_ENTRY
</span></span><span class="line"><span class="cl">   +0x000 InLoadOrderLinks : _LIST_ENTRY <span class="o">[</span> 0x0000019b<span class="sb">`</span>49df68c0 - 0x0000019b<span class="sb">`</span>49df62f0 <span class="o">]</span>
</span></span><span class="line"><span class="cl">   +0x010 InMemoryOrderLinks : _LIST_ENTRY <span class="o">[</span> 0x0000019b<span class="sb">`</span>49df68d0 - 0x0000019b<span class="sb">`</span>49df6300 <span class="o">]</span>
</span></span><span class="line"><span class="cl">   +0x020 InInitializationOrderLinks : _LIST_ENTRY <span class="o">[</span> 0x0000019b<span class="sb">`</span>49df70f0 - 0x00007ff8<span class="sb">`</span>d51108f0 <span class="o">]</span>
</span></span><span class="line"><span class="cl">   +0x030 DllBase          : 0x00007ff8<span class="sb">`</span>d4f40000 Void
</span></span><span class="line"><span class="cl">   +0x038 EntryPoint       : <span class="o">(</span>null<span class="o">)</span> 
</span></span><span class="line"><span class="cl">   +0x040 SizeOfImage      : 0x263000
</span></span><span class="line"><span class="cl">   +0x048 FullDllName      : _UNICODE_STRING <span class="s2">&#34;C:\WINDOWS\SYSTEM32\ntdll.dll&#34;</span>
</span></span><span class="line"><span class="cl">   +0x058 BaseDllName      : _UNICODE_STRING <span class="s2">&#34;ntdll.dll&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt;  dt nt!_LDR_DATA_TABLE_ENTRY 0x0000019b<span class="sb">`</span>49df68d0-10
</span></span><span class="line"><span class="cl">ntdll!_LDR_DATA_TABLE_ENTRY
</span></span><span class="line"><span class="cl">   +0x000 InLoadOrderLinks : _LIST_ENTRY <span class="o">[</span> 0x0000019b<span class="sb">`</span>49df70d0 - 0x0000019b<span class="sb">`</span>49df6040 <span class="o">]</span>
</span></span><span class="line"><span class="cl">   +0x010 InMemoryOrderLinks : _LIST_ENTRY <span class="o">[</span> 0x0000019b<span class="sb">`</span>49df70e0 - 0x0000019b<span class="sb">`</span>49df6050 <span class="o">]</span>
</span></span><span class="line"><span class="cl">   +0x020 InInitializationOrderLinks : _LIST_ENTRY <span class="o">[</span> 0x00007ff8<span class="sb">`</span>d51108f0 - 0x0000019b<span class="sb">`</span>49df70f0 <span class="o">]</span>
</span></span><span class="line"><span class="cl">   +0x030 DllBase          : 0x00007ff8<span class="sb">`</span>d3930000 Void
</span></span><span class="line"><span class="cl">   +0x038 EntryPoint       : 0x00007ff8<span class="sb">`</span>d395e120 Void
</span></span><span class="line"><span class="cl">   +0x040 SizeOfImage      : 0xc8000
</span></span><span class="line"><span class="cl">   +0x048 FullDllName      : _UNICODE_STRING <span class="s2">&#34;C:\WINDOWS\System32\KERNEL32.DLL&#34;</span>
</span></span><span class="line"><span class="cl">   +0x058 BaseDllName      : _UNICODE_STRING <span class="s2">&#34;KERNEL32.DLL&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt;  dt nt!_LDR_DATA_TABLE_ENTRY 0x0000019b<span class="sb">`</span>49df70e0-10
</span></span><span class="line"><span class="cl">ntdll!_LDR_DATA_TABLE_ENTRY
</span></span><span class="line"><span class="cl">   +0x000 InLoadOrderLinks : _LIST_ENTRY <span class="o">[</span> 0x00007ff8<span class="sb">`</span>d51108d0 - 0x0000019b<span class="sb">`</span>49df68c0 <span class="o">]</span>
</span></span><span class="line"><span class="cl">   +0x010 InMemoryOrderLinks : _LIST_ENTRY <span class="o">[</span> 0x00007ff8<span class="sb">`</span>d51108e0 - 0x0000019b<span class="sb">`</span>49df68d0 <span class="o">]</span>
</span></span><span class="line"><span class="cl">   +0x020 InInitializationOrderLinks : _LIST_ENTRY <span class="o">[</span> 0x0000019b<span class="sb">`</span>49df68e0 - 0x0000019b<span class="sb">`</span>49df6060 <span class="o">]</span>
</span></span><span class="line"><span class="cl">   +0x030 DllBase          : 0x00007ff8<span class="sb">`</span>d2310000 Void
</span></span><span class="line"><span class="cl">   +0x038 EntryPoint       : 0x00007ff8<span class="sb">`</span>d2436da0 Void
</span></span><span class="line"><span class="cl">   +0x040 SizeOfImage      : 0x3b2000
</span></span><span class="line"><span class="cl">   +0x048 FullDllName      : _UNICODE_STRING <span class="s2">&#34;C:\WINDOWS\System32\KERNELBASE.dll&#34;</span>
</span></span><span class="line"><span class="cl">   +0x058 BaseDllName      : _UNICODE_STRING <span class="s2">&#34;KERNELBASE.dll&#34;</span>
</span></span><span class="line"><span class="cl">   +0x068 FlagGroup        : <span class="o">[</span>4<span class="o">]</span>  <span class="s2">&#34;???&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0: kd&gt; dt nt!_UNICODE_STRING
</span></span><span class="line"><span class="cl">   +0x000 Length           : Uint2B
</span></span><span class="line"><span class="cl">   +0x002 MaximumLength    : Uint2B
</span></span><span class="line"><span class="cl">   +0x008 Buffer           : Ptr64 Wchar
</span></span></code></pre></div><h3 id="windows-shellcode">Windows Shellcode<a href="#windows-shellcode" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p><strong>Creating the simplest shellcode imaginable</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">bits</span><span class="w"> </span><span class="mi">64</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">section</span><span class="w"> </span><span class="p">.</span><span class="n">text</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">global</span><span class="w"> </span><span class="n">start</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">start</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">gs</span>:<span class="p">[</span><span class="mh">0x60</span><span class="p">]</span><span class="w">      </span><span class="p">;</span><span class="w"> </span><span class="no">TEB</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x18</span><span class="p">]</span><span class="w">   </span><span class="p">;</span><span class="w"> </span><span class="no">PEB</span><span class="p">.</span><span class="n">Ldr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x20</span><span class="p">]</span><span class="w">   </span><span class="p">;</span><span class="w"> </span><span class="no">PEB</span><span class="p">.</span><span class="n">Ldr</span>-&gt;<span class="nc">InMemoryOrderModuleList</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="p">]</span><span class="w">          </span><span class="p">;</span><span class="w"> </span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sub</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="w">           </span><span class="p">;</span><span class="w"> </span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="p">.</span><span class="n">InMemoryOrderLinks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x58</span><span class="w">           </span><span class="p">;</span><span class="w"> </span><span class="n">BaseDll</span>-&gt;<span class="nc">_UNICODE_STRING</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x08</span><span class="p">]</span><span class="w">   </span><span class="p">;</span><span class="w"> </span><span class="n">BaseDll</span>-&gt;<span class="nc">_UNICODE_STRING</span><span class="p">.</span><span class="n">Buffer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">xor</span><span class="w"> </span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="n">rcx</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">ret</span><span class="w"> 
</span></span></span></code></pre></div><h5 id="building-and-linking">Building and Linking<a href="#building-and-linking" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<p>Build it with Visual Studio</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nasm -f win64 -g -F cv8 -o shellcode.obj shellcode.asm
</span></span><span class="line"><span class="cl">link /SUBSYSTEM:CONSOLE /ENTRY:start /OUT:execute.exe /DEBUG  shellcode.obj 
</span></span></code></pre></div><h5 id="debugging-with-windbg">Debugging with WinDbg<a href="#debugging-with-windbg" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<p>Open it in WinDbg.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt; lm
</span></span><span class="line"><span class="cl">start             end                 module name
</span></span><span class="line"><span class="cl">00007ff7<span class="sb">`</span>6b490000 00007ff7<span class="sb">`</span>6b495000   execute  C <span class="o">(</span>pdb symbols<span class="o">)</span>
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>cd030000 00007ff8<span class="sb">`</span>cd0cc000   apphelp    <span class="o">(</span>deferred<span class="o">)</span>             
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>d2310000 00007ff8<span class="sb">`</span>d26c2000   KERNELBASE   <span class="o">(</span>deferred<span class="o">)</span>             
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>d3930000 00007ff8<span class="sb">`</span>d39f8000   KERNEL32   <span class="o">(</span>deferred<span class="o">)</span>             
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>d4f40000 00007ff8<span class="sb">`</span>d51a3000   ntdll      <span class="o">(</span>pdb symbols<span class="o">)</span>     
</span></span></code></pre></div><p>Inspect all the functions</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt; x execute!*
</span></span><span class="line"><span class="cl">00007ff7<span class="sb">`</span>6b491000 execute!start <span class="o">(</span>start<span class="o">)</span>
</span></span></code></pre></div><p>Set a breakpoint at entrypoint</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt; bp <span class="nv">$exentry</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0:000&gt; g
</span></span><span class="line"><span class="cl">Breakpoint <span class="m">0</span> hit
</span></span><span class="line"><span class="cl">execute!start:
</span></span><span class="line"><span class="cl">00007ff6<span class="sb">`</span>46f41000 65488b042560000000 mov   rax,qword ptr gs:<span class="o">[</span>60h<span class="o">]</span> gs:00000000<span class="sb">`</span><span class="nv">00000060</span><span class="o">=</span>????????????????
</span></span></code></pre></div><p>Set a breakpoint at start function</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt; bp 00007ff7<span class="sb">`</span>6b491000
</span></span><span class="line"><span class="cl">0:000&gt; bl
</span></span><span class="line"><span class="cl">     <span class="m">0</span> e Disable Clear  00007ff7<span class="sb">`</span>6b491000      <span class="m">0001</span> <span class="o">(</span>0001<span class="o">)</span>  0:**** execute!start
</span></span></code></pre></div><p>Trace it in Debugger</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt; t
</span></span><span class="line"><span class="cl">execute!start+0x9:
</span></span><span class="line"><span class="cl">00007ff6<span class="sb">`</span>46f41009 488b4018        mov     rax,qword ptr <span class="o">[</span>rax+18h<span class="o">]</span> ds:0000008f<span class="sb">`</span><span class="nv">f4b28018</span><span class="o">={</span>ntdll!PebLdr <span class="o">(</span>00007ff8<span class="sb">`</span>d51108c0<span class="o">)}</span>
</span></span><span class="line"><span class="cl">0:000&gt; t
</span></span><span class="line"><span class="cl">execute!start+0xd:
</span></span><span class="line"><span class="cl">00007ff6<span class="sb">`</span>46f4100d 488b4020        mov     rax,qword ptr <span class="o">[</span>rax+20h<span class="o">]</span> ds:00007ff8<span class="sb">`</span><span class="nv">d51108e0</span><span class="o">=</span>000001d7b1ebaf70
</span></span><span class="line"><span class="cl">0:000&gt; t
</span></span><span class="line"><span class="cl">execute!start+0x11:
</span></span><span class="line"><span class="cl">00007ff6<span class="sb">`</span>46f41011 488b00          mov     rax,qword ptr <span class="o">[</span>rax<span class="o">]</span> ds:000001d7<span class="sb">`</span><span class="nv">b1ebaf70</span><span class="o">=</span>000001d7b1ebacc0
</span></span><span class="line"><span class="cl">0:000&gt; t
</span></span><span class="line"><span class="cl">execute!start+0x14:
</span></span><span class="line"><span class="cl">00007ff6<span class="sb">`</span>46f41014 4883e810        sub     rax,10h
</span></span><span class="line"><span class="cl">0:000&gt; t
</span></span><span class="line"><span class="cl">execute!start+0x18:
</span></span><span class="line"><span class="cl">00007ff6<span class="sb">`</span>46f41018 4883c058        add     rax,58h
</span></span><span class="line"><span class="cl">0:000&gt; t
</span></span><span class="line"><span class="cl">execute!start+0x1c:
</span></span><span class="line"><span class="cl">00007ff6<span class="sb">`</span>46f4101c 488b4008        mov     rax,qword ptr <span class="o">[</span>rax+8<span class="o">]</span> ds:000001d7<span class="sb">`</span><span class="nv">b1ebad10</span><span class="o">={</span>ntdll!<span class="sb">`</span>string <span class="o">(</span>00007ff8<span class="sb">`</span>d50bc388<span class="o">)}</span>
</span></span><span class="line"><span class="cl">0:000&gt; r
</span></span><span class="line"><span class="cl"><span class="nv">rax</span><span class="o">=</span>000001d7b1ebad08 <span class="nv">rbx</span><span class="o">=</span><span class="m">0000000000000000</span> <span class="nv">rcx</span><span class="o">=</span>0000008ff4b28000
</span></span><span class="line"><span class="cl"><span class="nv">rdx</span><span class="o">=</span>00007ff646f41000 <span class="nv">rsi</span><span class="o">=</span><span class="m">0000000000000000</span> <span class="nv">rdi</span><span class="o">=</span><span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl"><span class="nv">rip</span><span class="o">=</span>00007ff646f4101c <span class="nv">rsp</span><span class="o">=</span>0000008ff493f848 <span class="nv">rbp</span><span class="o">=</span><span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl"> <span class="nv">r8</span><span class="o">=</span>0000008ff4b28000  <span class="nv">r9</span><span class="o">=</span>00007ff646f41000 <span class="nv">r10</span><span class="o">=</span><span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl"><span class="nv">r11</span><span class="o">=</span><span class="m">0000000000000000</span> <span class="nv">r12</span><span class="o">=</span><span class="m">0000000000000000</span> <span class="nv">r13</span><span class="o">=</span><span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl"><span class="nv">r14</span><span class="o">=</span><span class="m">0000000000000000</span> <span class="nv">r15</span><span class="o">=</span><span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl"><span class="nv">iopl</span><span class="o">=</span><span class="m">0</span>         nv up ei pl nz na pe nc
</span></span><span class="line"><span class="cl"><span class="nv">cs</span><span class="o">=</span><span class="m">0033</span>  <span class="nv">ss</span><span class="o">=</span>002b  <span class="nv">ds</span><span class="o">=</span>002b  <span class="nv">es</span><span class="o">=</span>002b  <span class="nv">fs</span><span class="o">=</span><span class="m">0053</span>  <span class="nv">gs</span><span class="o">=</span>002b             <span class="nv">efl</span><span class="o">=</span><span class="m">00000202</span>
</span></span><span class="line"><span class="cl">execute!start+0x1c:
</span></span><span class="line"><span class="cl">00007ff6<span class="sb">`</span>46f4101c 488b4008        mov     rax,qword ptr <span class="o">[</span>rax+8<span class="o">]</span> ds:000001d7<span class="sb">`</span><span class="nv">b1ebad10</span><span class="o">={</span>ntdll!<span class="sb">`</span>string <span class="o">(</span>00007ff8<span class="sb">`</span>d50bc388<span class="o">)}</span>
</span></span><span class="line"><span class="cl">0:000&gt; dt nt!_UNICODE_STRING @rax
</span></span><span class="line"><span class="cl">ntdll!_UNICODE_STRING
</span></span><span class="line"><span class="cl"> <span class="s2">&#34;ntdll.dll&#34;</span>
</span></span><span class="line"><span class="cl">   +0x000 Length           : 0x12
</span></span><span class="line"><span class="cl">   +0x002 MaximumLength    : 0x14
</span></span><span class="line"><span class="cl">   +0x008 Buffer           : 0x00007ff8<span class="sb">`</span>d50bc388  <span class="s2">&#34;ntdll.dll&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0:000&gt; t
</span></span><span class="line"><span class="cl">execute!start+0x20:
</span></span><span class="line"><span class="cl">00007ff6<span class="sb">`</span>46f41020 4831c9          xor     rcx,rcx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0:000&gt; du @rax
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>d50bc388  <span class="s2">&#34;ntdll.dll&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0:000&gt; t
</span></span><span class="line"><span class="cl">execute!start+0x23:
</span></span><span class="line"><span class="cl">00007ff6<span class="sb">`</span>46f41023 c3              ret
</span></span></code></pre></div><h4 id="extending-the-shellcode">Extending the Shellcode<a href="#extending-the-shellcode" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h4>
<p><strong>Extending the above code</strong></p>
<ul>
<li>Added traversing the loaded modules</li>
<li>Iterating over each module name.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="n">bits</span><span class="w"> </span><span class="mi">64</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">section</span><span class="w"> </span><span class="p">.</span><span class="n">text</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">global</span><span class="w"> </span><span class="n">start</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">start</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">gs</span>:<span class="p">[</span><span class="mh">0x60</span><span class="p">]</span><span class="w">       </span><span class="p">;</span><span class="w"> </span><span class="no">TEB</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x18</span><span class="p">]</span><span class="w">    </span><span class="p">;</span><span class="w"> </span><span class="no">PEB</span><span class="p">.</span><span class="n">Ldr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x20</span><span class="p">]</span><span class="w">    </span><span class="p">;</span><span class="w"> </span><span class="no">PEB</span><span class="p">.</span><span class="n">Ldr</span>-&gt;<span class="nc">InMemoryOrderModuleList</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">repeat</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="p">]</span><span class="w">           </span><span class="p">;</span><span class="w"> </span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mh">0x40</span><span class="p">]</span><span class="w">    </span><span class="p">;</span><span class="w"> </span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="p">.</span><span class="n">SizeOfImage</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">cmp</span><span class="w"> </span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0</span><span class="w">        
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">je</span><span class="w"> </span><span class="n">done</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">sub</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="w">            </span><span class="p">;</span><span class="w"> </span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="p">.</span><span class="n">InMemoryOrderLinks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">add</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x58</span><span class="w">            </span><span class="p">;</span><span class="w"> </span><span class="n">BaseDll</span>-&gt;<span class="nc">_UNICODE_STRING</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">jmp</span><span class="w"> </span><span class="n">find_names</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">find_names</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">mov</span><span class="w"> </span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="p">]</span><span class="w">          </span><span class="p">;</span><span class="w"> </span><span class="n">BaseDll</span>-&gt;<span class="nc">_UNICODE_STRING</span><span class="p">.</span><span class="n">Length</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">and</span><span class="w"> </span><span class="n">rcx</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="mh">0x0fff</span><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="n">BaseDll</span>-&gt;<span class="nc">_UNICODE_STRING</span><span class="p">.</span><span class="n">Length</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0fff</span><span class="w"> </span><span class="p">(</span><span class="no">DWORD</span><span class="p">)</span><span class="w"> </span><span class="c1">// Not Neccessary !!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rbx</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="mh">0x08</span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">BaseDll</span>-&gt;<span class="nc">_UNICODE_STRING</span><span class="p">.</span><span class="n">Buffer</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">iterate_chars</span>:  
</span></span><span class="line"><span class="cl">     <span class="nc">sub</span><span class="w"> </span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="w">          </span><span class="p">;</span><span class="w"> </span><span class="no">UTF</span><span class="o">-</span><span class="mi">16</span><span class="w"> </span><span class="n">Chars</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">cmp</span><span class="w"> </span><span class="n">rcx</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="w">          </span><span class="p">;</span><span class="w"> </span><span class="n">Counter</span><span class="w"> </span><span class="n">Check</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">je</span><span class="w"> </span><span class="n">next_iteration</span><span class="w">      
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">jmp</span><span class="w"> </span><span class="n">iterate_chars</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">next_iteration</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">sub</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="mh">0x48</span><span class="w">   </span><span class="p">;</span><span class="w"> </span><span class="no">_LDR_DATA_TABLE_ENTRY</span><span class="p">.</span><span class="n">InMemoryOrderLinks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mov</span><span class="w"> </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">rax</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="no">_LIST_ENTRY</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">jmp</span><span class="w"> </span><span class="n">repeat</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">done</span>:
</span></span><span class="line"><span class="cl">    <span class="nc">ret</span><span class="w"> 
</span></span></span></code></pre></div><h5 id="debugging-with-windbg-1">Debugging with WinDbg<a href="#debugging-with-windbg-1" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h5>
<p>Again attach a debugger</p>
<p>Set a breakpoint at <code>execute!start+0x42</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt; bp execute!start+0x42
</span></span><span class="line"><span class="cl">0:000&gt; bl
</span></span><span class="line"><span class="cl">     <span class="m">0</span> e Disable Clear  00007ff7<span class="sb">`</span>bcf01000      <span class="m">0001</span> <span class="o">(</span>0001<span class="o">)</span>  0:**** execute!start
</span></span><span class="line"><span class="cl">     <span class="m">1</span> e Disable Clear  00007ff7<span class="sb">`</span>bcf01042      <span class="m">0001</span> <span class="o">(</span>0001<span class="o">)</span>  0:**** execute!start+0x42
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0:000&gt; g
</span></span><span class="line"><span class="cl">Breakpoint <span class="m">0</span> hit
</span></span><span class="line"><span class="cl">execute!start:
</span></span><span class="line"><span class="cl">00007ff7<span class="sb">`</span>bcf01000 65488b042560000000 mov   rax,qword ptr gs:<span class="o">[</span>60h<span class="o">]</span> gs:00000000<span class="sb">`</span><span class="nv">00000060</span><span class="o">=</span>????????????????
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0:000&gt; g
</span></span><span class="line"><span class="cl">Breakpoint <span class="m">1</span> hit
</span></span><span class="line"><span class="cl">execute!start+0x42:
</span></span><span class="line"><span class="cl">00007ff7<span class="sb">`</span>bcf01042 4883e848        sub     rax,48h
</span></span></code></pre></div><p>Inspect the registers</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt; r
</span></span><span class="line"><span class="cl"><span class="nv">rax</span><span class="o">=</span>00000222ed066098 <span class="nv">rbx</span><span class="o">=</span>00007ff8d50bc388 <span class="nv">rcx</span><span class="o">=</span><span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl"><span class="nv">rdx</span><span class="o">=</span>00007ff7bcf01000 <span class="nv">rsi</span><span class="o">=</span><span class="m">0000000000000000</span> <span class="nv">rdi</span><span class="o">=</span><span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl"><span class="nv">rip</span><span class="o">=</span>00007ff7bcf01042 <span class="nv">rsp</span><span class="o">=</span>000000483a6ffd38 <span class="nv">rbp</span><span class="o">=</span><span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl"> <span class="nv">r8</span><span class="o">=</span>000000483a544000  <span class="nv">r9</span><span class="o">=</span>00007ff7bcf01000 <span class="nv">r10</span><span class="o">=</span><span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl"><span class="nv">r11</span><span class="o">=</span><span class="m">0000000000000000</span> <span class="nv">r12</span><span class="o">=</span><span class="m">0000000000000000</span> <span class="nv">r13</span><span class="o">=</span><span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl"><span class="nv">r14</span><span class="o">=</span><span class="m">0000000000000000</span> <span class="nv">r15</span><span class="o">=</span><span class="m">0000000000000000</span>
</span></span><span class="line"><span class="cl"><span class="nv">iopl</span><span class="o">=</span><span class="m">0</span>         nv up ei pl zr na po nc
</span></span><span class="line"><span class="cl"><span class="nv">cs</span><span class="o">=</span><span class="m">0033</span>  <span class="nv">ss</span><span class="o">=</span>002b  <span class="nv">ds</span><span class="o">=</span>002b  <span class="nv">es</span><span class="o">=</span>002b  <span class="nv">fs</span><span class="o">=</span><span class="m">0053</span>  <span class="nv">gs</span><span class="o">=</span>002b             <span class="nv">efl</span><span class="o">=</span><span class="m">00000246</span>
</span></span><span class="line"><span class="cl">execute!start+0x42:
</span></span><span class="line"><span class="cl">00007ff7<span class="sb">`</span>bcf01042 4883e848        sub     rax,48h
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt; dt nt!_UNICODE_STRING @rax
</span></span><span class="line"><span class="cl">ntdll!_UNICODE_STRING
</span></span><span class="line"><span class="cl"> <span class="s2">&#34;ntdll.dll&#34;</span>
</span></span><span class="line"><span class="cl">   +0x000 Length           : 0x12
</span></span><span class="line"><span class="cl">   +0x002 MaximumLength    : 0x14
</span></span><span class="line"><span class="cl">   +0x008 Buffer           : 0x00007ff8<span class="sb">`</span>d50bc388  <span class="s2">&#34;ntdll.dll&#34;</span>
</span></span></code></pre></div><p>Unicode Buffer is at 0x08. Add 0x08 to rax.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt; du poi<span class="o">(</span>@rax+0x08<span class="o">)</span>
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>d50bc388  <span class="s2">&#34;ntdll.dll&#34;</span>
</span></span></code></pre></div><p>Continue it</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt; g
</span></span><span class="line"><span class="cl">Breakpoint <span class="m">1</span> hit
</span></span><span class="line"><span class="cl">execute!start+0x42:
</span></span><span class="line"><span class="cl">00007ff7<span class="sb">`</span>bcf01042 4883e848        sub     rax,48h
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0:000&gt; du poi<span class="o">(</span>@rax+0x08<span class="o">)</span>
</span></span><span class="line"><span class="cl">00000222<span class="sb">`</span>ed0672e8  <span class="s2">&#34;KERNELBASE.dll&#34;</span>
</span></span></code></pre></div><p>Continue</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt; g
</span></span><span class="line"><span class="cl">Breakpoint <span class="m">1</span> hit
</span></span><span class="line"><span class="cl">execute!start+0x42:
</span></span><span class="line"><span class="cl">00007ff7<span class="sb">`</span>bcf01042 4883e848        sub     rax,48h
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0:000&gt; du poi<span class="o">(</span>@rax+0x08<span class="o">)</span>
</span></span><span class="line"><span class="cl">00000222<span class="sb">`</span>ed065e10  <span class="s2">&#34;execute.exe&#34;</span>
</span></span></code></pre></div><p>Again Continue</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt; g
</span></span><span class="line"><span class="cl">Breakpoint <span class="m">1</span> hit
</span></span><span class="line"><span class="cl">execute!start+0x42:
</span></span><span class="line"><span class="cl">00007ff7<span class="sb">`</span>bcf01042 4883e848        sub     rax,48h
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">0:000&gt; du poi<span class="o">(</span>@rax+0x08<span class="o">)</span>
</span></span><span class="line"><span class="cl">00000222<span class="sb">`</span>ed066ad8  <span class="s2">&#34;KERNEL32.DLL&#34;</span>
</span></span></code></pre></div><p>Process Terminates</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt; g
</span></span><span class="line"><span class="cl">ntdll!NtTerminateProcess+0x14:
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>d509fca4 c3              ret
</span></span></code></pre></div><p>Check all the loaded modules</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">0:000&gt; lm
</span></span><span class="line"><span class="cl">start             end                 module name
</span></span><span class="line"><span class="cl">00007ff7<span class="sb">`</span>bcf00000 00007ff7<span class="sb">`</span>bcf05000   execute  C <span class="o">(</span>pdb symbols<span class="o">)</span>          
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>d2310000 00007ff8<span class="sb">`</span>d26c2000   KERNELBASE   <span class="o">(</span>deferred<span class="o">)</span>             
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>d3930000 00007ff8<span class="sb">`</span>d39f8000   KERNEL32   <span class="o">(</span>pdb symbols<span class="o">)</span>          
</span></span><span class="line"><span class="cl">00007ff8<span class="sb">`</span>d4f40000 00007ff8<span class="sb">`</span>d51a3000   ntdll      <span class="o">(</span>pdb symbols<span class="o">)</span>          
</span></span><span class="line"><span class="cl">   
</span></span></code></pre></div>
      </div></div>

  
    
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h"></span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="http://localhost:1313/posts/windows-shellcode2/">
                <span class="button__icon">â†</span>
                <span class="button__text">Windows Shellcode Development &amp; Debugging with WinDbg: A Hands-On Guide (Part 2)</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="http://localhost:1313/posts/pe-parse-windbg2/">
                <span class="button__text">PE Parsing: A Step-by-Step Guide with WinDbg - Part 2</span>
                <span class="button__icon">â†’</span>
            </a>
        </span>
        
    </div>
</div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>Â© 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/mirus-ua/hugo-theme-re-terminal" target="_blank">Theme</a> made by <a href="https://github.com/mirus-ua" target="_blank">Mirus</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>








  
</div>

</body>
</html>
